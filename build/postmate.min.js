/**
  @barrman/postmate - A powerful, simple, promise-based postMessage library
  @version v1.6.0
  @link https://github.com/BarrMan/postmate
  @author Imri Barr <emree3@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Postmate=t()}(this,function(){"use strict";function h(e,t){return("string"!=typeof t||e.origin===t)&&(!!e.data&&(("object"!=typeof e.data||"postmate"in e.data)&&(e.data.type===c&&!!n[e.data.postmate])))}var c="application/x-postmate-v1+json",r={maxHandshakeRequests:5,handshakeIntervalMs:500},s=0,n={handshake:1,"handshake-reply":1,call:1,emit:1,reply:1,request:1},p=function(){function e(e){var a=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},this.listener=function(e){if(!h(e,a.childOrigin))return!1;var t=((e||{}).data||{}).value||{},n=t.data,t=t.name;"emit"===e.data.postmate&&t in a.events&&a.events[t].forEach(function(e){e.call(a,n)})},this.parent.addEventListener("message",this.listener,!1)}var t=e.prototype;return t.get=function(e){var i=this;return new d.Promise(function(n){var a=++s;i.parent.addEventListener("message",function e(t){t.data.uid===a&&"reply"===t.data.postmate&&(i.parent.removeEventListener("message",e,!1),n(t.data.value))},!1),i.child.postMessage({postmate:"request",type:c,property:e,uid:a},i.childOrigin)})},t.call=function(e,t){this.child.postMessage({postmate:"call",type:c,property:e,data:t},this.childOrigin)},t.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},t.destroy=function(){window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)},e}(),o=function(){function e(e){var i=this;this.model=e.model,this.parent=e.parent,this.parentOrigin=e.parentOrigin,this.child=e.child,this.child.addEventListener("message",function(t){var n,a,e;h(t,i.parentOrigin)&&(e=t.data,n=e.property,a=e.uid,e=e.data,"call"!==t.data.postmate?function(e,t){e="function"==typeof e[t]?e[t]():e[t];return d.Promise.resolve(e)}(i.model,n).then(function(e){return t.source.postMessage({property:n,postmate:"reply",type:c,uid:a,value:e},t.origin)}):n in i.model&&"function"==typeof i.model[n]&&i.model[n](e))})}return e.prototype.emit=function(e,t){this.parent.postMessage({postmate:"emit",type:c,value:{name:e,data:t}},this.parentOrigin)},e}(),d=function(){function a(e){var t=e.container,n=void 0===t?void 0!==n?n:document.body:t,t=e.model,a=e.url,i=e.name,s=e.classListArray,s=void 0===s?[]:s,e=e.handshakeConfig,e=void 0===e?r:e;return this.parent=window,this.frame=document.createElement("iframe"),this.frame.name=i||"",this.frame.classList.add.apply(this.frame.classList,s),n.appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=t||{},this.maxHandshakeRequests=5,this.handshakeConfig=Object.assign({},r,e),this.sendHandshake(a)}return a.prototype.sendHandshake=function(i){var e,t,n,s,r=this,o=(e=i,(t=document.createElement("a")).href=e,e=(4<t.protocol.length?t:window.location).protocol,n=t.host.length?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host,t.origin||e+"//"+n),d=0;return new a.Promise(function(n,a){function e(){d++,r.child.postMessage({postmate:"handshake",type:c,model:r.model},o),d===r.handshakeConfig.maxHandshakeRequests&&(clearInterval(s),a("Parent: Max attempts reached"))}function t(){e(),s=setInterval(e,r.handshakeConfig.handshakeIntervalMs)}r.parent.addEventListener("message",function e(t){return!!h(t,o)&&("handshake-reply"===t.data.postmate?(clearInterval(s),r.parent.removeEventListener("message",e,!1),r.childOrigin=t.origin,n(new p(r))):a("Failed handshake"))},!1);r.frame.attachEvent?r.frame.attachEvent("onload",t):r.frame.addEventListener("load",t),r.frame.src=i})},a}();return d.debug=!1,d.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),d.Model=function(){function e(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return e.prototype.sendHandshakeReply=function(){var s=this;return new d.Promise(function(a,i){s.child.addEventListener("message",function e(t){var n;if(t.data.postmate)return"handshake"===t.data.postmate?(s.child.removeEventListener("message",e,!1),t.source.postMessage({postmate:"handshake-reply",type:c},t.origin),s.parentOrigin=t.origin,(n=t.data.model)&&Object.keys(n).forEach(function(e){s.model[e]=n[e]}),a(new o(s))):i("Handshake Reply Failed")},!1)})},e}(),d});
